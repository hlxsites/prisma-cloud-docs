== AWS CloudFront viewer protocol policy is not configured with HTTPS

=== Rule Details

[cols="1,2"]
|===
|Cortex AppSec Rule ID |APPSEC_AWS_34
|Category |Public Exposure - Encryption and Protocols
|Provider |AWS
|Severity |MEDIUM
|Framework |CloudFormation, Terraform, Terraform Plan, Serverless
|Mapped CSPM/KSPM Rule |2cc26fd5-4a45-427e-a3d6-53d77c1790af
|===


=== Impact
*AWS::CloudFront::Distribution ViewerCertificate* determines the distribution's SSL/TLS configuration for communicating with viewers.
We recommend you use the *ViewerProtocolPolicy* parameter to enable secure HTTPS communication between clients and your CloudFormation templates.
Most browsers and clients released after 2010 support server name indication.
AWS recommends to accept HTTPS connections only from viewers that support SNI and advises against receiving HTTPS connections from all viewers, including those that do not support SNI, set SslSupportMethod.
This also results in additional monthly charges from CloudFront.

=== Fix - Buildtime


*Terraform* 


* *Resource:* aws_cloudfront_distribution
* *Arguments:*  `viewer_protocol_policy` under `default_cache_behavior` or `ordered_cache_behavior` must not be `allow-all`.
Acceptable values are `redirect-to-https` or `https-only`.


[source,go]
----
resource "aws_cloudfront_distribution" "cloudfront" {
  ...
  default_cache_behavior {
    ...
    target_origin_id       = "my-origin"
 -  viewer_protocol_policy = "allow-all"
 +  viewer_protocol_policy = "redirect-to-https"
  }
}
----


*CloudFormation* 


* *Resource:* AWS::CloudFront::Distribution
* *Arguments:*  `ViewerProtocolPolicy` under Properties.DefaultCacheBehavior or Properties.CacheBehaviors must not be `allow-all`.
Acceptable values are `redirect-to-https` or `https-only`.


[source,yaml]
----
Resources:
    CloudFrontDistribution:
    Type: 'AWS::CloudFront::Distribution'
    Properties:
      DistributionConfig:
        ...
        DefaultCacheBehavior:
          ...
-         ViewerProtocolPolicy: 'allow-all'
+         ViewerProtocolPolicy: 'https-only' # or 'redirect-to-https'

        CacheBehaviors:
          - TargetOriginId: customorigin
                        ...
-           ViewerProtocolPolicy: allow-all
+           ViewerProtocolPolicy: https-only # or redirect-to-https
----
