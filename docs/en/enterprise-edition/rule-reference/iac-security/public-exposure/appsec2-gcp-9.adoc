== GCP Container Registry repositories are anonymously or publicly accessible


=== Rule Details

[cols="1,2"]
|===
|Cortex AppSec Rule ID |APPSEC2_GCP_9
|Category |Public Exposure - Storage Buckets
|Provider |GCP
|Severity |HIGH
|Framework |Terraform
|Mapped CSPM/KSPM Rule |None
|===


=== Fix - Runtime


* GCP Console* 


To remove anonymous or public access to your GCR repositories:

. Log in to the GCP Console at https://console.cloud.google.com.

. Navigate to https://console.cloud.google.com/gcr/settings [GCR Settings].

. Under _Public access_ locate the repositories that say * PUBLIC* under the _Visibility_ column.

. Select the dropdown and switch to * PRIVATE*.


* CLI Command* 


To remove anonymous or public access to your GCR repositories use the `gsutil` command:


[source,shell]
----
{
 "gsutil iam ch -d PRINCIPAL gs://BUCKET-NAME
",
}
----
Replace * PRINCIPAL* with either _allUsers_ or _allAuthenticatedUsers_ depending on your Cortex Cloud alert.
Replace * BUCKET-NAME* with the GCS bucket where your images are stored.
The * BUCKET-NAME* can be determined by executing `gsutil ls` and your Container Registry bucket URL will be listed as `gs://artifacts.PROJECT-ID.appspot.com` or `gs://STORAGE-REGION.artifacts.PROJECT-ID.appspot.com`.
* PROJECT-ID* and * STORAGE-REGION* will be replaced with your GCP project ID or the region where your GCR repository is configured.
////

=== Fix - Buildtime


*Terraform* 


* *Resource:* google_storage_bucket_iam_binding
* *Field:* members
* *Resource:* google_storage_bucket_iam_member
* *Field:* member
Google Container Registry (GCR) does not have IAM-specific resources in Terraform.
Instead, GCR IAM is handled via GCS IAM resources as seen in the below examples.


[source,go]
----
resource "google_storage_bucket_iam_binding" "gcr_public_binding" {
  bucket = google_storage_bucket.default.name
  role = "roles/storage.viewer"

  members = [
-    "allUsers",
-    "allAuthenticatedUsers",
  ]
}
----


[source,go]
----
resource "google_artifact_registry_repository_iam_member" "public_member" {
  provider = google-beta
  location = google_artifact_registry_repository.my-repo.location
  repository = google_artifact_registry_repository.my-repo.name
  role = "roles/artifactregistry.writer"

-  member = "allUsers"
-  member = "allAuthenticatedUsers"
}
----


[source,go]
----
resource "google_storage_bucket_iam_member" "gcr_public_member" {
  bucket = google_storage_bucket.default.name
  role = "roles/storage.viewer"

-  member = "allUsers"
-  member = "allAuthenticatedUsers"
}
----
